<div class="user-panel">
  <!-- LOADING -->
  <div *ngIf="isLoading" class="loading">Loading...</div>

  <!-- ERROR -->
  <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

  <!-- USER -->
  <div class="user-header" *ngIf="user">
    <div class="user-header-top">
      <span class="username">@{{ user.username }}</span>
    </div>
    <span class="display-name">{{ user.name }}</span>
    <span class="rating">â­ rating: {{ user.ratingNumber }}</span>
  </div>

  <div class="divider" *ngIf="user"></div>

  <!-- RECENT SONGS -->
  <div class="section" *ngIf="!isLoading">
    <h3>ğŸµ Recent songs</h3>
    <ul *ngIf="recentSongs.length > 0">
      <li *ngFor="let song of recentSongs">
        {{ song.title }} â€“ {{ song.artist }}
        <span class="category">({{ song.category }})</span>
      </li>
    </ul>
    <p *ngIf="recentSongs.length === 0">No songs yet.</p>
  </div>

  <div class="divider" *ngIf="!isLoading"></div>

  <!-- BADGES -->
  <div class="section" *ngIf="!isLoading">
    <h3>ğŸ† Badges</h3>
    <ul *ngIf="badges.length > 0">
      <li *ngFor="let badge of badges">
        <strong>{{ badge.name }}</strong>
        <span class="badge-desc">â€“ {{ badge.description }}</span>
      </li>
    </ul>
    <p *ngIf="badges.length === 0">No badges yet.</p>
  </div>

  <div class="divider" *ngIf="!isLoading"></div>

  <!-- GROUPS -->
  <div class="section" *ngIf="!isLoading">
    <div class="section-header">
      <h3>ğŸ‘¥ Groups</h3>
      <button class="add-group-btn" (click)="toggleCreateGroup()">+</button>
    </div>
    
    <!-- Create Group Form -->
    <div class="create-group-form" *ngIf="showCreateGroup">
      <input 
        type="text" 
        [(ngModel)]="newGroupName" 
        placeholder="Group name"
        class="create-group-input"
        [disabled]="isCreatingGroup">
      <button 
        class="create-btn" 
        (click)="createGroup()"
        [disabled]="isCreatingGroup || !newGroupName.trim()">
        {{ isCreatingGroup ? '...' : 'Create' }}
      </button>
    </div>
    <p class="create-status" *ngIf="createGroupStatus" [class.success]="createGroupStatus.startsWith('âœ“')">{{ createGroupStatus }}</p>
    
    <ul *ngIf="groups.length > 0" class="groups">
      <li *ngFor="let group of groups" (click)="openGroupPopup(group)" class="group-item">
        ğŸ‘¥ {{ group.name }}
      </li>
    </ul>
    <p *ngIf="groups.length === 0">No groups yet.</p>
  </div>

  <div class="divider" *ngIf="!isLoading"></div>

  <!-- LOGOUT -->
  <button class="retro-btn logout-btn" (click)="logout()" *ngIf="!isLoading">
    ğŸšª Logout
  </button>

  <!-- NOTIFICATIONS - Fixed bottom left -->
  <div class="notifications-section" *ngIf="!isLoading">
    <app-notifications></app-notifications>
  </div>
</div>

<!-- GROUP POPUP MODAL -->
<div class="modal-overlay" *ngIf="selectedGroup" (click)="closeGroupPopup()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeGroupPopup()">âœ•</button>
    
    <h2 class="modal-title">ğŸ‘¥ {{ selectedGroup.name }}</h2>

    <div *ngIf="isLoadingGroup" class="modal-loading">Loading...</div>

    <div *ngIf="!isLoadingGroup">
      <!-- MEMBERS -->
      <div class="modal-section">
        <h3>ğŸ‘¤ Members</h3>
        <ul *ngIf="selectedGroup.members && selectedGroup.members.length > 0">
          <li *ngFor="let member of selectedGroup.members">
            <span class="member-name">{{ member.name }}</span>
            <span class="member-username">@{{ member.username }}</span>
          </li>
        </ul>
        <p *ngIf="!selectedGroup.members || selectedGroup.members.length === 0">No members yet.</p>
      </div>

      <!-- SHARED SONGS -->
      <div class="modal-section">
        <h3>ğŸµ Shared Songs</h3>
        <ul *ngIf="selectedGroup.sharedSongs && selectedGroup.sharedSongs.length > 0">
          <li *ngFor="let sharedSong of selectedGroup.sharedSongs">
            <div class="shared-song-info">
              <span class="song-title">{{ sharedSong.song.title }}</span>
              <span class="song-artist">â€“ {{ sharedSong.song.artist }}</span>
            </div>
            <div class="song-meta">
              <span class="song-sender">shared by @{{ sharedSong.sender.username }}</span>
              <span class="star-count">â­ {{ sharedSong.starCount || 0 }}</span>
            </div>
            <button 
              class="star-btn" 
              *ngIf="canGiveStar(sharedSong)"
              (click)="giveStar(sharedSong)">
              â­ Give Star
            </button>
            <span class="already-starred" *ngIf="hasUserStarred(sharedSong)">âœ“ You starred this</span>
            <span class="own-song" *ngIf="sharedSong.sender.id === userId">Your share</span>
          </li>
        </ul>
        <p *ngIf="!selectedGroup.sharedSongs || selectedGroup.sharedSongs.length === 0">No shared songs yet.</p>
      </div>

      <!-- INVITE USER -->
      <div class="modal-section invite-section">
        <h3>âœ‰ï¸ Invite User</h3>
        <div class="invite-form">
          <input 
            type="text" 
            [(ngModel)]="inviteUsername" 
            placeholder="Enter username"
            class="invite-input"
            [disabled]="isInviting">
          <button 
            class="invite-btn" 
            (click)="inviteUser()"
            [disabled]="isInviting || !inviteUsername.trim()">
            {{ isInviting ? 'Sending...' : 'Send Invite' }}
          </button>
        </div>
        <p class="invite-status" *ngIf="inviteStatus" [class.success]="inviteStatus.startsWith('âœ“')">
          {{ inviteStatus }}
        </p>
      </div>

      <!-- LEAVE GROUP -->
      <div class="modal-section leave-section">
        <button 
          class="leave-btn" 
          (click)="leaveGroup()"
          [disabled]="isLeavingGroup">
          {{ isLeavingGroup ? 'Leaving...' : 'ğŸšª Leave Group' }}
        </button>
        <p class="leave-status" *ngIf="leaveStatus">{{ leaveStatus }}</p>
      </div>

      <!-- ACTIVITY LOG -->
      <div class="modal-section activity-section" *ngIf="selectedGroup.activities && selectedGroup.activities.length > 0">
        <h3>ğŸ“‹ Recent Activity</h3>
        <ul class="activity-list">
          <li *ngFor="let activity of selectedGroup.activities" class="activity-item" [ngClass]="activity.type.toLowerCase()">
            <span class="activity-icon">{{ activity.type === 'MEMBER_JOINED' ? 'â¡ï¸' : 'â¬…ï¸' }}</span>
            <span class="activity-message">{{ activity.message }}</span>
            <span class="activity-time">{{ formatActivityTime(activity.createdAt) }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
